àA
[/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Services/PasswordManager.cs
public 
class 
PasswordManager 
{ 
private 
readonly 
byte 
[ 
] 
_key  
;  !
private		 
readonly		 
byte		 
[		 
]		 
_iv		 
;		  
string

 


_secretKey

 
=

 
$str

 
;

 
public 

PasswordManager 
( 
string !
	EncDecKey" +
)+ ,
{ 

_secretKey 
= 
	EncDecKey 
; 
using 
( 
var 
deriveBytes 
=  
new! $
Rfc2898DeriveBytes% 7
(7 8

_secretKey 
, 
new 
byte 
[ 
] 
{ 
$num 
, 
$num #
,# $
$num% )
,) *
$num+ /
,/ 0
$num1 5
,5 6
$num7 ;
,; <
$num= A
,A B
$numC G
}H I
,I J
$num 
, 
HashAlgorithmName 
. 
SHA256 $
) 	
)	 

{ 	
_key 
= 
deriveBytes 
. 
GetBytes '
(' (
$num( *
)* +
;+ ,
_iv 
= 
deriveBytes 
. 
GetBytes &
(& '
$num' )
)) *
;* +
} 	
} 
public 

string 
Encrypt 
( 
string  
	plainText! *
)* +
{ 
if 

( 
string 
. 
IsNullOrEmpty  
(  !
	plainText! *
)* +
)+ ,
throw 
new !
ArgumentNullException +
(+ ,
nameof, 2
(2 3
	plainText3 <
)< =
)= >
;> ?
byte!! 
[!! 
]!! 
encryptedBytes!! 
;!! 
using## 
(## 
var## 
aesAlg## 
=## 
Aes## 
.##  
Create##  &
(##& '
)##' (
)##( )
{$$ 	
aesAlg%% 
.%% 
Key%% 
=%% 
_key%% 
;%% 
aesAlg(( 
.(( 

GenerateIV(( 
((( 
)(( 
;((  
byte)) 
[)) 
])) 
iv)) 
=)) 
aesAlg)) 
.)) 
IV)) !
;))! "
ICryptoTransform++ 
	encryptor++ &
=++' (
aesAlg++) /
.++/ 0
CreateEncryptor++0 ?
(++? @
aesAlg++@ F
.++F G
Key++G J
,++J K
iv++L N
)++N O
;++O P
using-- 
(-- 
var-- 
	msEncrypt--  
=--! "
new--# &
MemoryStream--' 3
(--3 4
)--4 5
)--5 6
{.. 
	msEncrypt00 
.00 
Write00 
(00  
iv00  "
,00" #
$num00$ %
,00% &
iv00' )
.00) *
Length00* 0
)000 1
;001 2
using22 
(22 
var22 
	csEncrypt22 $
=22% &
new22' *
CryptoStream22+ 7
(227 8
	msEncrypt228 A
,22A B
	encryptor22C L
,22L M
CryptoStreamMode22N ^
.22^ _
Write22_ d
)22d e
)22e f
using33 
(33 
var33 
	swEncrypt33 $
=33% &
new33' *
StreamWriter33+ 7
(337 8
	csEncrypt338 A
)33A B
)33B C
{44 
	swEncrypt55 
.55 
Write55 #
(55# $
	plainText55$ -
)55- .
;55. /
}66 
encryptedBytes88 
=88  
	msEncrypt88! *
.88* +
ToArray88+ 2
(882 3
)883 4
;884 5
}99 
}:: 	
return<< 
Convert<< 
.<< 
ToBase64String<< %
(<<% &
encryptedBytes<<& 4
)<<4 5
;<<5 6
}== 
public?? 

string?? 
Decrypt?? 
(?? 
string??  

cipherText??! +
)??+ ,
{@@ 
ifAA 

(AA 
stringAA 
.AA 
IsNullOrEmptyAA  
(AA  !

cipherTextAA! +
)AA+ ,
)AA, -
throwBB 
newBB !
ArgumentNullExceptionBB +
(BB+ ,
nameofBB, 2
(BB2 3

cipherTextBB3 =
)BB= >
)BB> ?
;BB? @
byteDD 
[DD 
]DD 
cipherBytesDD 
=DD 
ConvertDD $
.DD$ %
FromBase64StringDD% 5
(DD5 6

cipherTextDD6 @
)DD@ A
;DDA B
usingFF 
(FF 
varFF 
aesAlgFF 
=FF 
AesFF 
.FF  
CreateFF  &
(FF& '
)FF' (
)FF( )
{GG 	
aesAlgHH 
.HH 
KeyHH 
=HH 
_keyHH 
;HH 
byteKK 
[KK 
]KK 
ivKK 
=KK 
newKK 
byteKK  
[KK  !
$numKK! #
]KK# $
;KK$ %
ArrayLL 
.LL 
CopyLL 
(LL 
cipherBytesLL "
,LL" #
$numLL$ %
,LL% &
ivLL' )
,LL) *
$numLL+ ,
,LL, -
ivLL. 0
.LL0 1
LengthLL1 7
)LL7 8
;LL8 9
aesAlgMM 
.MM 
IVMM 
=MM 
ivMM 
;MM 
ICryptoTransformOO 
	decryptorOO &
=OO' (
aesAlgOO) /
.OO/ 0
CreateDecryptorOO0 ?
(OO? @
aesAlgOO@ F
.OOF G
KeyOOG J
,OOJ K
aesAlgOOL R
.OOR S
IVOOS U
)OOU V
;OOV W
usingQQ 
(QQ 
varQQ 
	msDecryptQQ  
=QQ! "
newQQ# &
MemoryStreamQQ' 3
(QQ3 4
cipherBytesQQ4 ?
,QQ? @
$numQQA C
,QQC D
cipherBytesQQE P
.QQP Q
LengthQQQ W
-QQX Y
$numQQZ \
)QQ\ ]
)QQ] ^
usingRR 
(RR 
varRR 
	csDecryptRR  
=RR! "
newRR# &
CryptoStreamRR' 3
(RR3 4
	msDecryptRR4 =
,RR= >
	decryptorRR? H
,RRH I
CryptoStreamModeRRJ Z
.RRZ [
ReadRR[ _
)RR_ `
)RR` a
usingSS 
(SS 
varSS 
	srDecryptSS  
=SS! "
newSS# &
StreamReaderSS' 3
(SS3 4
	csDecryptSS4 =
)SS= >
)SS> ?
{TT 
returnUU 
	srDecryptUU  
.UU  !
	ReadToEndUU! *
(UU* +
)UU+ ,
;UU, -
}VV 
}WW 	
}XX 
public\\ 

string\\ 
GenerateSecureKey\\ #
(\\# $
int\\$ '
keySizeInBytes\\( 6
=\\7 8
$num\\9 ;
)\\; <
{]] 
byte^^ 
[^^ 
]^^ 
key^^ 
=^^ 
new^^ 
byte^^ 
[^^ 
keySizeInBytes^^ ,
]^^, -
;^^- .
using__ 
(__ 
var__ 
rng__ 
=__ !
RandomNumberGenerator__ .
.__. /
Create__/ 5
(__5 6
)__6 7
)__7 8
{`` 	
rngaa 
.aa 
GetBytesaa 
(aa 
keyaa 
)aa 
;aa 
}bb 	
returncc 
Convertcc 
.cc 
ToBase64Stringcc %
(cc% &
keycc& )
)cc) *
;cc* +
}dd 
}ee 6
J/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
var

 "
MyAllowSpecificOrigins

 
=

 
$str

 7
;

7 8
builder 
. 
Services 
. 
AddCors 
( 
options  
=>! #
{ 
options 
. 
	AddPolicy 
( 
name 
: "
MyAllowSpecificOrigins 2
,2 3
policy 

=> 
{ 
policy 
. 
WithOrigins 
( 
$str 3
,3 4
$str5 N
)N O
. 	
AllowAnyHeader	 
( 
) 
. 	
AllowAnyMethod	 
( 
) 
. 	
AllowCredentials	 
( 
) 
; 
} 
) 
; 
} 
) 
; 
builder 
. 
Services 
. 
AddRateLimiter 
(  
options  '
=>( *
{ 
options 
. 
GlobalLimiter 
= "
PartitionedRateLimiter 2
.2 3
Create3 9
<9 :
HttpContext: E
,E F
stringG M
>M N
(N O
httpContextO Z
=>[ ]
RateLimitPartition 
. !
GetFixedWindowLimiter 0
(0 1
partitionKey 
: 
httpContext %
.% &
User& *
.* +
Identity+ 3
?3 4
.4 5
Name5 9
??: <
httpContext= H
.H I
RequestI P
.P Q
HeadersQ X
.X Y
HostY ]
.] ^
ToString^ f
(f g
)g h
,h i
factory 
: 
	partition 
=> !
new" %)
FixedWindowRateLimiterOptions& C
{ 
AutoReplenishment !
=" #
true$ (
,( )
PermitLimit   
=   
$num   
,    

QueueLimit!! 
=!! 
$num!! 
,!! 
Window"" 
="" 
TimeSpan"" !
.""! "
FromSeconds""" -
(""- .
$num"". /
)""/ 0
}## 
)## 
)## 
;## 
}$$ 
)$$ 
;$$ 
builder'' 
.'' 
Services'' 
.'' 
AddDbContext'' 
<''  
ApplicationDbContext'' 2
>''2 3
(''3 4
options''4 ;
=>''< >
options(( 
.(( 
	UseSqlite(( 
((( 
builder(( 
.(( 
Configuration(( +
.((+ ,
GetConnectionString((, ?
(((? @
$str((@ S
)((S T
)((T U
)((U V
;((V W
builder)) 
.)) 
Services)) 
.)) 
AddControllers)) 
())  
)))  !
;))! "
var// 
key// 
=// 	
Encoding//
 
.// 
ASCII// 
.// 
GetBytes// !
(//! "
builder//" )
.//) *
Configuration//* 7
.//7 8
GetValue//8 @
<//@ A
string//A G
>//G H
(//H I
$str//I R
)//R S
)//S T
;//T U
builder00 
.00 
Services00 
.00 
AddAuthentication00 "
(00" #
JwtBearerDefaults00# 4
.004 5 
AuthenticationScheme005 I
)00I J
.11 
AddJwtBearer11 
(11 
options11 
=>11 
{22 
options33 
.33  
RequireHttpsMetadata33 $
=33% &
false33' ,
;33, -
options44 
.44 
	SaveToken44 
=44 
true44  
;44  !
options55 
.55 %
TokenValidationParameters55 )
=55* +
new55, /%
TokenValidationParameters550 I
{66 	$
ValidateIssuerSigningKey77 $
=77% &
true77' +
,77+ ,
IssuerSigningKey88 
=88 
new88 " 
SymmetricSecurityKey88# 7
(887 8
key888 ;
)88; <
,88< =
ValidateIssuer99 
=99 
false99 "
,99" #
ValidateAudience:: 
=:: 
false:: $
};; 	
;;;	 

}<< 
)<< 
;<< 
var>> 
app>> 
=>> 	
builder>>
 
.>> 
Build>> 
(>> 
)>> 
;>> 
ifAA 
(AA 
!AA 
appAA 
.AA 	
EnvironmentAA	 
.AA 
IsDevelopmentAA "
(AA" #
)AA# $
)AA$ %
{BB 
appCC 
.CC 
UseHstsCC 
(CC 
)CC 
;CC 
appDD 
.DD 
UseHttpsRedirectionDD 
(DD 
)DD 
;DD 
}FF 
appJJ 
.JJ 
UseCorsJJ 
(JJ "
MyAllowSpecificOriginsJJ "
)JJ" #
;JJ# $
appLL 
.LL 
UseMiddlewareLL 
<LL "
ErrorHandlerMiddlewareLL (
>LL( )
(LL) *
)LL* +
;LL+ ,
ifOO 
(OO 
appOO 
.OO 
EnvironmentOO 
.OO 
IsDevelopmentOO !
(OO! "
)OO" #
)OO# $
{PP 
appQQ 
.QQ %
UseDeveloperExceptionPageQQ !
(QQ! "
)QQ" #
;QQ# $
}RR 
appTT 
.TT 
UseAuthenticationTT 
(TT 
)TT 
;TT 
appUU 
.UU 
UseAuthorizationUU 
(UU 
)UU 
;UU 
appWW 
.WW 
UseMiddlewareWW 
<WW 
GlobalMiddlewareWW "
>WW" #
(WW# $
)WW$ %
;WW% &
appXX 
.XX 
UseRateLimiterXX 
(XX 
)XX 
;XX 
appYY 
.YY 
UseHttpsRedirectionYY 
(YY 
)YY 
;YY 
app\\ 
.\\ 
MapControllers\\ 
(\\ 
)\\ 
;\\ 
app^^ 
.^^ 
Run^^ 
(^^ 
)^^ 	
;^^	 
ù

N/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Models/User.cs
	namespace 	
RestApi
 
. 
Models 
{ 
[ 
Index 

(
 
nameof 
( 
Username 
) 
, 
IsUnique %
=& '
true( ,
), -
]- .
public 

class 
User 
{ 
[		 	
Key			 
]		 
public

 
int

 
Id

 
{

 
get

 
;

 
set

  
;

  !
}

" #
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
string/ 5
.5 6
Empty6 ;
;; <
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
string/ 5
.5 6
Empty6 ;
;; <
public 
string 
Role 
{ 
get  
;  !
set" %
;% &
}' (
=) *
string+ 1
.1 2
Empty2 7
;7 8
} 
} Ä
Q/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Models/Product.cs
	namespace 	
RestApi
 
. 
Models 
{ 
public 

class 
Product 
{ 
[ 	
Key	 
] 
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
[

 	
Required

	 
]

 
public 
string 
Name 
{ 
get  
;  !
set" %
;% &
}' (
=) *
string+ 1
.1 2
Empty2 7
;7 8
[ 	
Required	 
] 
public 
decimal 
Price 
{ 
get "
;" #
set$ '
;' (
}) *
} 
} ù	
N/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Models/Note.cs
	namespace 	
RestApi
 
. 
Models 
{ 
public 

class 
Note 
{ 
[ 	
Key	 
] 
public		 
int		 
Id		 
{		 
get		 
;		 
set		  
;		  !
}		" #
[ 	
Required	 
] 
public 
string 
Content 
{ 
get  #
;# $
set% (
;( )
}* +
=, -
string. 4
.4 5
Empty5 :
;: ;
[ 	
Required	 
] 
public 
int 
UserId 
{ 
get 
;  
set! $
;$ %
}& '
[ 	

ForeignKey	 
( 
$str 
) 
] 
public 
User 
User 
{ 
get 
; 
set  #
;# $
}% &
=' (
null) -
!- .
;. /
} 
} —
Z/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Models/dto/UserLoginDto.cs
	namespace 	
RestApi
 
. 
Models 
. 
Dto 
{ 
public 

class 
UserLoginDto 
{ 
[

 	
Required

	 
]

 
[ 	
StringLength	 
( 
maximumLength #
:# $
$num% (
,( )
MinimumLength* 7
=8 9
$num: ;
,; <
ErrorMessage= I
=J K
$strL {
){ |
]| }
[ 	
EmailAddress	 
( 
ErrorMessage "
=# $
$str% H
)H I
]I J
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
string/ 5
.5 6
Empty6 ;
;; <
[ 	
Required	 
] 
[ 	
StringLength	 
( 
maximumLength #
:# $
$num% '
,' (
MinimumLength) 6
=7 8
$num9 :
,: ;
ErrorMessage< H
=I J
$strK y
)y z
]z {
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
string/ 5
.5 6
Empty6 ;
;; <
[ 	
Required	 
] 
[ 	
	CityValid	 
( 
ErrorMessage 
=  !
$str" ^
)^ _
]_ `
public 
string 
City 
{ 
get  
;  !
set" %
;% &
}' (
=) *
string+ 1
.1 2
Empty2 7
;7 8
} 
} Ä

_/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Migrations/20251125084652_v1.cs
	namespace 	
RestApi
 
. 

Migrations 
{ 
public 

partial 
class 
v1 
: 
	Migration '
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateIndex (
(( )
name 
: 
$str )
,) *
table 
: 
$str 
, 
column 
: 
$str "
," #
unique 
: 
true 
) 
; 
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
	DropIndex &
(& '
name 
: 
$str )
,) *
table 
: 
$str 
) 
;  
} 	
} 
} È9
j/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Migrations/20250311115221_InitialCreate.cs
	namespace 	
RestApi
 
. 

Migrations 
{ 
public 

partial 
class 
InitialCreate &
:' (
	Migration) 2
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str  
,  !
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 :
,: ;
nullable< D
:D E
falseF K
)K L
. 

Annotation #
(# $
$str$ :
,: ;
true< @
)@ A
,A B
Name 
= 
table  
.  !
Column! '
<' (
string( .
>. /
(/ 0
type0 4
:4 5
$str6 <
,< =
nullable> F
:F G
falseH M
)M N
,N O
Price 
= 
table !
.! "
Column" (
<( )
decimal) 0
>0 1
(1 2
type2 6
:6 7
$str8 >
,> ?
nullable@ H
:H I
falseJ O
)O P
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% 2
,2 3
x4 5
=>6 8
x9 :
.: ;
Id; =
)= >
;> ?
} 
) 
; 
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str 
, 
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 :
,: ;
nullable< D
:D E
falseF K
)K L
.   

Annotation   #
(  # $
$str  $ :
,  : ;
true  < @
)  @ A
,  A B
Username!! 
=!! 
table!! $
.!!$ %
Column!!% +
<!!+ ,
string!!, 2
>!!2 3
(!!3 4
type!!4 8
:!!8 9
$str!!: @
,!!@ A
nullable!!B J
:!!J K
false!!L Q
)!!Q R
,!!R S
Password"" 
="" 
table"" $
.""$ %
Column""% +
<""+ ,
string"", 2
>""2 3
(""3 4
type""4 8
:""8 9
$str"": @
,""@ A
nullable""B J
:""J K
false""L Q
)""Q R
,""R S
Role## 
=## 
table##  
.##  !
Column##! '
<##' (
string##( .
>##. /
(##/ 0
type##0 4
:##4 5
$str##6 <
,##< =
nullable##> F
:##F G
false##H M
)##M N
}$$ 
,$$ 
constraints%% 
:%% 
table%% "
=>%%# %
{&& 
table'' 
.'' 

PrimaryKey'' $
(''$ %
$str''% /
,''/ 0
x''1 2
=>''3 5
x''6 7
.''7 8
Id''8 :
)'': ;
;''; <
}(( 
)(( 
;(( 
migrationBuilder** 
.** 
CreateTable** (
(**( )
name++ 
:++ 
$str++ 
,++ 
columns,, 
:,, 
table,, 
=>,, !
new,," %
{-- 
Id.. 
=.. 
table.. 
... 
Column.. %
<..% &
int..& )
>..) *
(..* +
type..+ /
:../ 0
$str..1 :
,..: ;
nullable..< D
:..D E
false..F K
)..K L
.// 

Annotation// #
(//# $
$str//$ :
,//: ;
true//< @
)//@ A
,//A B
Content00 
=00 
table00 #
.00# $
Column00$ *
<00* +
string00+ 1
>001 2
(002 3
type003 7
:007 8
$str009 ?
,00? @
nullable00A I
:00I J
false00K P
)00P Q
,00Q R
UserId11 
=11 
table11 "
.11" #
Column11# )
<11) *
int11* -
>11- .
(11. /
type11/ 3
:113 4
$str115 >
,11> ?
nullable11@ H
:11H I
false11J O
)11O P
}22 
,22 
constraints33 
:33 
table33 "
=>33# %
{44 
table55 
.55 

PrimaryKey55 $
(55$ %
$str55% /
,55/ 0
x551 2
=>553 5
x556 7
.557 8
Id558 :
)55: ;
;55; <
table66 
.66 

ForeignKey66 $
(66$ %
name77 
:77 
$str77 5
,775 6
column88 
:88 
x88  !
=>88" $
x88% &
.88& '
UserId88' -
,88- .
principalTable99 &
:99& '
$str99( /
,99/ 0
principalColumn:: '
:::' (
$str::) -
,::- .
onDelete;;  
:;;  !
ReferentialAction;;" 3
.;;3 4
Cascade;;4 ;
);;; <
;;;< =
}<< 
)<< 
;<< 
migrationBuilder>> 
.>> 
CreateIndex>> (
(>>( )
name?? 
:?? 
$str?? '
,??' (
table@@ 
:@@ 
$str@@ 
,@@ 
columnAA 
:AA 
$strAA  
)AA  !
;AA! "
}BB 	
	protectedEE 
overrideEE 
voidEE 
DownEE  $
(EE$ %
MigrationBuilderEE% 5
migrationBuilderEE6 F
)EEF G
{FF 	
migrationBuilderGG 
.GG 
	DropTableGG &
(GG& '
nameHH 
:HH 
$strHH 
)HH 
;HH 
migrationBuilderJJ 
.JJ 
	DropTableJJ &
(JJ& '
nameKK 
:KK 
$strKK  
)KK  !
;KK! "
migrationBuilderMM 
.MM 
	DropTableMM &
(MM& '
nameNN 
:NN 
$strNN 
)NN 
;NN 
}OO 	
}PP 
}QQ É
^/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Middleware/GlobalMiddleware.cs
public 
class 
GlobalMiddleware 
{ 
private 
readonly 
RequestDelegate $
_next% *
;* +
public 

GlobalMiddleware 
( 
RequestDelegate +
next, 0
)0 1
{ 
_next		 
=		 
next		 
;		 
}

 
public 

async 
Task 
Invoke 
( 
HttpContext (
context) 0
)0 1
{ 
var 
ip 
= 
context 
. 

Connection #
.# $
RemoteIpAddress$ 3
?3 4
.4 5
ToString5 =
(= >
)> ?
;? @
var 
agent 
= 
context 
. 
Request #
.# $
Headers$ +
[+ ,
$str, 8
]8 9
.9 :
ToString: B
(B C
)C D
;D E
var 
path 
= 
context 
. 
Request "
." #
Path# '
.' (
ToString( 0
(0 1
)1 2
;2 3
var 
	timestamp 
= 
DateTime  
.  !
UtcNow! '
.' (
ToString( 0
(0 1
$str1 F
)F G
;G H
var 
username 
= 
context 
. 
User #
?# $
.$ %
Identity% -
?- .
.. /
IsAuthenticated/ >
==? A
trueB F
? 
context 
. 
User 
. 
Identity #
.# $
Name$ (
: 
$str 
; 
var 
log 
= 
new 
{ 	
IP 
= 
ip 
, 
	UserAgent 
= 
agent 
, 
Username 
= 
username 
,  
Path 
= 
path 
, 
	Timestamp 
= 
	timestamp !
} 	
;	 

Console!! 
.!! 
	WriteLine!! 
(!! 
$str!! 8
)!!8 9
;!!9 :
Console"" 
."" 
	WriteLine"" 
("" 
JsonSerializer"" (
.""( )
	Serialize"") 2
(""2 3
log""3 6
,""6 7
new""8 ;!
JsonSerializerOptions""< Q
{""R S
WriteIndented""T a
=""b c
true""d h
}""i j
)""j k
)""k l
;""l m
await$$ 
_next$$ 
($$ 
context$$ 
)$$ 
;$$ 
}%% 
}&& ØJ
d/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Middleware/ErrorHandlerMiddleware.cs
public 
class "
ErrorHandlerMiddleware #
{ 
private 
readonly 
RequestDelegate $
_next% *
;* +
private 
readonly 
IHostEnvironment %
_env& *
;* +
private 
readonly 
ILogger 
< "
ErrorHandlerMiddleware 3
>3 4
_logger5 <
;< =
public 
"
ErrorHandlerMiddleware !
(! "
RequestDelegate" 1
next2 6
,6 7
IHostEnvironment" 2
env3 6
,6 7
ILogger		" )
<		) *"
ErrorHandlerMiddleware		* @
>		@ A
logger		B H
)		H I
{

 
_next 
= 
next 
; 
_env 
= 
env 
; 
_logger 
= 
logger 
; 
} 
public 

async 
Task 
Invoke 
( 
HttpContext (
context) 0
)0 1
{ 
try 
{ 	
await 
_next 
( 
context 
)  
;  !
} 	
catch 
( 
	Exception 
error 
) 
{ 	
var 
response 
= 
context "
." #
Response# +
;+ ,
response 
. 
ContentType  
=! "
$str# 5
;5 6
response 
. 

StatusCode 
=  !
error" '
switch( .
{ '
UnauthorizedAccessException +
=>, .
StatusCodes/ :
.: ;!
Status401Unauthorized; P
,P Q 
KeyNotFoundException $
=>% '
StatusCodes( 3
.3 4
Status404NotFound4 E
,E F
ArgumentException !
=>" $
StatusCodes% 0
.0 1
Status400BadRequest1 D
,D E
_   
=>   
StatusCodes    
.    !(
Status500InternalServerError  ! =
}!! 
;!! 
var## 
isDev## 
=## 
_env## 
.## 
IsDevelopment## *
(##* +
)##+ ,
;##, -
var&& 
logText&& 
=&& 
BuildLogMessage&& )
(&&) *
error&&* /
,&&/ 0
context&&1 8
)&&8 9
;&&9 :
var** 
logWriteStart** 
=** 
DateTime**  (
.**( )
Now**) ,
;**, -
await++ 
WriteLogToFileAsync++ %
(++% &
logText++& -
)++- .
;++. /
var,, 
logWriteEnd,, 
=,, 
DateTime,, &
.,,& '
Now,,' *
;,,* +
var-- 
logWriteDuration--  
=--! "
(--# $
logWriteEnd--$ /
---0 1
logWriteStart--2 ?
)--? @
.--@ A
TotalMilliseconds--A R
;--R S
Console.. 
... 
	WriteLine.. 
(.. 
$"..  
$str..  2
{..2 3
logWriteDuration..3 C
}..C D
$str..D G
"..G H
)..H I
;..I J
if11 
(11 
isDev11 
)11 
{22 
_logger33 
.33 
LogError33  
(33  !
error33! &
,33& '
$"33( *
$str33* 6
{336 7
error337 <
.33< =
Message33= D
}33D E
"33E F
)33F G
;33G H
Console44 
.44 
	WriteLine44 !
(44! "
$str44" 9
)449 :
;44: ;
Console55 
.55 
	WriteLine55 !
(55! "
$"55" $
$str55$ .
{55. /
error55/ 4
.554 5
Message555 <
}55< =
"55= >
)55> ?
;55? @
Console66 
.66 
	WriteLine66 !
(66! "
$"66" $
$str66$ .
{66. /
error66/ 4
.664 5
GetType665 <
(66< =
)66= >
.66> ?
Name66? C
}66C D
"66D E
)66E F
;66F G
Console77 
.77 
	WriteLine77 !
(77! "
$"77" $
$str77$ .
{77. /
error77/ 4
.774 5

StackTrace775 ?
}77? @
"77@ A
)77A B
;77B C
Console88 
.88 
	WriteLine88 !
(88! "
$str88" :
)88: ;
;88; <
}99 
else:: 
{;; 
_logger== 
.== 
LogError==  
(==  !
error==! &
,==& '
$"==( *
$str==* 7
{==7 8
error==8 =
.=== >
Message==> E
}==E F
"==F G
)==G H
;==H I
}>> 
varAA 
resultAA 
=AA 
isDevAA 
?BB 
SystemBB 
.BB 
TextBB 
.BB 
JsonBB "
.BB" #
JsonSerializerBB# 1
.BB1 2
	SerializeBB2 ;
(BB; <
newBB< ?
{CC 
statusDD 
=DD 
falseDD "
,DD" #
messageEE 
=EE 
errorEE #
.EE# $
MessageEE$ +
,EE+ ,
}HH 
)HH 
:II 
SystemII 
.II 
TextII 
.II 
JsonII "
.II" #
JsonSerializerII# 1
.II1 2
	SerializeII2 ;
(II; <
newII< ?
{JJ 
statusKK 
=KK 
falseKK "
,KK" #
messageLL 
=LL 
$strLL T
}MM 
)MM 
;MM 
awaitOO 
responseOO 
.OO 

WriteAsyncOO %
(OO% &
resultOO& ,
)OO, -
;OO- .
}PP 	
}QQ 
privateSS 
staticSS 
stringSS 
BuildLogMessageSS -
(SS- .
	ExceptionSS. 7
errorSS8 =
,SS= >
HttpContextSS? J
contextSSK R
)SSR S
{TT 
returnUU 
$@"UU 
$strUW 
{WW 
DateTimeWW 
.WW 
NowWW !
:WW! "
$strWW" 5
}WW5 6
$strWX6 
{XX 
DateTimeXX 
.XX 
NowXX !
:XX! "
$strXX" &
}XX& '
$strXY' 
{YY 
contextYY 
.YY 
RequestYY $
.YY$ %
PathYY% )
}YY) *
$strYZ* 
{ZZ 
contextZZ 
.ZZ 
RequestZZ $
.ZZ$ %
MethodZZ% +
}ZZ+ ,
$strZ[, 
{[[ 
error[[ 
.[[ 
Message[[ "
}[[" #
$str[\# 
{\\ 
error\\ 
.\\ 
GetType\\ "
(\\" #
)\\# $
.\\$ %
Name\\% )
}\\) *
$str\]* 
{]] 
error]] 
.]] 

StackTrace]] %
}]]% &
$str]_& 
"__ 	
;__	 

}`` 
privatebb 
asyncbb 
Taskbb 
WriteLogToFileAsyncbb *
(bb* +
stringbb+ 1
textbb2 6
)bb6 7
{cc 
trydd 
{ee 	
vargg 
	logFoldergg 
=gg 
Pathgg  
.gg  !
Combinegg! (
(gg( )

AppContextgg) 3
.gg3 4
BaseDirectorygg4 A
,ggA B
$strggC I
)ggI J
;ggJ K
ifhh 
(hh 
!hh 
	Directoryhh 
.hh 
Existshh !
(hh! "
	logFolderhh" +
)hh+ ,
)hh, -
	Directoryii 
.ii 
CreateDirectoryii )
(ii) *
	logFolderii* 3
)ii3 4
;ii4 5
varll 
fileNamell 
=ll 
$"ll 
{ll 
DateTimell &
.ll& '
Nowll' *
:ll* +
$strll+ 5
}ll5 6
$strll6 7
{ll7 8
DateTimell8 @
.ll@ A
NowllA D
:llD E
$strllE I
}llI J
$strllJ N
"llN O
;llO P
varmm 
filePathmm 
=mm 
Pathmm 
.mm  
Combinemm  '
(mm' (
	logFoldermm( 1
,mm1 2
fileNamemm3 ;
)mm; <
;mm< =
awaitpp 
Filepp 
.pp 
AppendAllTextAsyncpp )
(pp) *
filePathpp* 2
,pp2 3
textpp4 8
)pp8 9
;pp9 :
}qq 	
catchrr 
(rr 
	Exceptionrr 
exrr 
)rr 
{ss 	
Consoleuu 
.uu 
	WriteLineuu 
(uu 
$struu 1
+uu2 3
exuu4 6
.uu6 7
Messageuu7 >
)uu> ?
;uu? @
}vv 	
}ww 
}yy ç	
\/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Data/ApplicationDbContext.cs
	namespace 	
RestApi
 
. 
Data 
{ 
public 

class  
ApplicationDbContext %
:& '
	DbContext( 1
{ 
public  
ApplicationDbContext #
(# $
DbContextOptions$ 4
<4 5 
ApplicationDbContext5 I
>I J
optionsK R
)R S
:T U
baseV Z
(Z [
options[ b
)b c
{d e
}f g
public

 
DbSet

 
<

 
User

 
>

 
Users

  
{

! "
get

# &
;

& '
set

( +
;

+ ,
}

- .
public 
DbSet 
< 
Note 
> 
Notes  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
DbSet 
< 
Product 
> 
Products &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
} 
} Ã
Y/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/CustomValids/CityValid.cs
	namespace 	
RestApi
 
. 
CustomValids 
{ 
public 

class 
	CityValid 
: 
ValidationAttribute 0
{ 
	protected 
override 
ValidationResult +
IsValid, 3
(3 4
object4 :
?: ;
value< A
,A B
ValidationContextC T
validationContextU f
)f g
{ 	
string		 
[		 
]		 
validCities		  
=		! "
{		# $
$str		% /
,		/ 0
$str		1 9
,		9 :
$str		; B
}		C D
;		D E
if

 
(

 
validCities

 
.

 
Contains

 $
(

$ %
value

% *
?

* +
.

+ ,
ToString

, 4
(

4 5
)

5 6
!

6 7
.

7 8
ToLower

8 ?
(

? @
)

@ A
)

A B
)

B C
{ 
return 
ValidationResult '
.' (
Success( /
;/ 0
} 
else 
{ 
return 
new 
ValidationResult +
(+ ,
$str, h
)h i
;i j
} 
} 	
} 
} "
`/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Controllers/ProductController.cs
	namespace 	
RestApi
 
. 
Controllers 
{ 
[		 
ApiController		 
]		 
[

 
Route

 

(


 
$str

 
)

 
]

 
[ 
	Authorize 
( 
Roles 
= 
$str  
)  !
]! "
public 

class 
ProductController "
:# $
ControllerBase% 3
{ 
private 
readonly  
ApplicationDbContext -
_context. 6
;6 7
public 
ProductController  
(  ! 
ApplicationDbContext! 5
context6 =
)= >
{ 	
_context 
= 
context 
; 
} 	
[ 	
HttpPost	 
] 
public 
IActionResult 
Create #
(# $
Product$ +
product, 3
)3 4
{ 	
_context 
. 
Products 
. 
Add !
(! "
product" )
)) *
;* +
_context 
. 
SaveChanges  
(  !
)! "
;" #
return 
Ok 
( 
product 
) 
; 
} 	
[ 	
HttpPut	 
( 
$str 
) 
] 
public 
IActionResult 
Update #
(# $
int$ '
id( *
,* +
Product, 3
product4 ;
); <
{ 	
var   
existingProduct   
=    !
_context  " *
.  * +
Products  + 3
.  3 4
Find  4 8
(  8 9
id  9 ;
)  ; <
;  < =
if!! 
(!! 
existingProduct!! 
==!!  "
null!!# '
)!!' (
{"" 
return## 
NotFound## 
(##  
)##  !
;##! "
}$$ 
existingProduct%% 
.%% 
Name%%  
=%%! "
product%%# *
.%%* +
Name%%+ /
;%%/ 0
existingProduct&& 
.&& 
Price&& !
=&&" #
product&&$ +
.&&+ ,
Price&&, 1
;&&1 2
_context'' 
.'' 
SaveChanges''  
(''  !
)''! "
;''" #
return(( 
Ok(( 
((( 
existingProduct(( %
)((% &
;((& '
})) 	
[++ 	

HttpDelete++	 
(++ 
$str++ 
)++ 
]++ 
public,, 
IActionResult,, 
Delete,, #
(,,# $
int,,$ '
id,,( *
),,* +
{-- 	
var.. 
product.. 
=.. 
_context.. "
..." #
Products..# +
...+ ,
Find.., 0
(..0 1
id..1 3
)..3 4
;..4 5
if// 
(// 
product// 
==// 
null// 
)//  
{00 
return11 
NotFound11 
(11  
)11  !
;11! "
}22 
_context33 
.33 
Products33 
.33 
Remove33 $
(33$ %
product33% ,
)33, -
;33- .
_context44 
.44 
SaveChanges44  
(44  !
)44! "
;44" #
return55 
Ok55 
(55 
)55 
;55 
}66 	
[88 	
HttpGet88	 
]88 
public99 
IActionResult99 
GetAll99 #
(99# $
)99$ %
{:: 	
var;; 
products;; 
=;; 
_context;; #
.;;# $
Products;;$ ,
.;;, -
ToList;;- 3
(;;3 4
);;4 5
;;;5 6
return<< 
Ok<< 
(<< 
products<< 
)<< 
;<<  
}== 	
}>> 
}?? « 
]/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Controllers/NoteController.cs
	namespace		 	
RestApi		
 
.		 
Controllers		 
{

 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
[ 
	Authorize 
( 
Roles 
= 
$str 
) 
] 
public 

class 
NoteController 
:  !
ControllerBase" 0
{ 
private 
readonly  
ApplicationDbContext -
_context. 6
;6 7
public 
NoteController 
(  
ApplicationDbContext 2
context3 :
): ;
{ 	
_context 
= 
context 
; 
} 	
[ 	
HttpPost	 
] 
public 
IActionResult 
Create #
(# $
Note$ (
note) -
)- .
{ 	
_context 
. 
Notes 
. 
Add 
( 
note #
)# $
;$ %
_context 
. 
SaveChanges  
(  !
)! "
;" #
return 
Ok 
( 
note 
) 
; 
} 	
[ 	
HttpPut	 
( 
$str 
) 
] 
public   
IActionResult   
Update   #
(  # $
int  $ '
id  ( *
,  * +
Note  , 0
note  1 5
)  5 6
{!! 	
var"" 
existingNote"" 
="" 
_context"" '
.""' (
Notes""( -
.""- .
Find"". 2
(""2 3
id""3 5
)""5 6
;""6 7
if## 
(## 
existingNote## 
==## 
null##  $
)##$ %
{$$ 
return%% 
NotFound%% 
(%%  
)%%  !
;%%! "
}&& 
existingNote'' 
.'' 
Content''  
=''! "
note''# '
.''' (
Content''( /
;''/ 0
_context(( 
.(( 
SaveChanges((  
(((  !
)((! "
;((" #
return)) 
Ok)) 
()) 
existingNote)) "
)))" #
;))# $
}** 	
[,, 	

HttpDelete,,	 
(,, 
$str,, 
),, 
],, 
public-- 
IActionResult-- 
Delete-- #
(--# $
int--$ '
id--( *
)--* +
{.. 	
var// 
note// 
=// 
_context// 
.//  
Notes//  %
.//% &
Find//& *
(//* +
id//+ -
)//- .
;//. /
if00 
(00 
note00 
==00 
null00 
)00 
{11 
return22 
NotFound22 
(22  
)22  !
;22! "
}33 
_context44 
.44 
Notes44 
.44 
Remove44 !
(44! "
note44" &
)44& '
;44' (
_context55 
.55 
SaveChanges55  
(55  !
)55! "
;55" #
return66 
Ok66 
(66 
)66 
;66 
}77 	
[99 	
HttpGet99	 
]99 
public:: 
IActionResult:: 
GetAll:: #
(::# $
)::$ %
{;; 	
var>> 
notes>> 
=>> 
_context>>  
.>>  !
Notes>>! &
.>>& '
ToList>>' -
(>>- .
)>>. /
;>>/ 0
return?? 
Ok?? 
(?? 
notes?? 
)?? 
;?? 
}@@ 	
}AA 
}BB ]
]/Users/hakan/Documents/GitHub/eti_2025_security/RestApi/RestApi/Controllers/AuthController.cs
	namespace 	
RestApi
 
. 
Controllers 
{ 
[ 

EnableCors 
( 
$str )
)) *
]* +
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
public 

class 
AuthController 
:  !
ControllerBase" 0
{ 
string 
name 
= 
$str 
; 
private 
readonly  
ApplicationDbContext -
_context. 6
;6 7
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
public 
AuthController 
(  
ApplicationDbContext 2
context3 :
,: ;
IConfiguration< J
configurationK X
)X Y
{ 	
_configuration 
= 
configuration *
;* +
_context 
= 
context 
; 
} 	
["" 	
HttpPost""	 
("" 
$str"" 
)"" 
]"" 
public## 
IActionResult## 
Register## %
(##% &
User##& *
user##+ /
)##/ 0
{$$ 	
if%% 
(%% 

ModelState%% 
.%% 
IsValid%% "
==%%# %
false%%& +
)%%+ ,
{&& 
return'' 

BadRequest'' !
(''! "

ModelState''" ,
)'', -
;''- .
}(( 
user)) 
.)) 
Password)) 
=)) 
BCrypt)) "
.))" #
Net))# &
.))& '
BCrypt))' -
.))- .
HashPassword)). :
()): ;
user)); ?
.))? @
Password))@ H
)))H I
;))I J
_context** 
.** 
Users** 
.** 
Add** 
(** 
user** #
)**# $
;**$ %
_context++ 
.++ 
SaveChanges++  
(++  !
)++! "
;++" #
return,, 
Ok,, 
(,, 
user,, 
),, 
;,, 
}-- 	
[// 	
HttpPost//	 
(// 
$str// 
)// 
]// 
public00 
IActionResult00 
	LoginUser00 &
(00& '
UserLoginDto00' 3
userDto004 ;
)00; <
{11 	
string33 
query33 
=33 
$str33 X
;33X Y
Console55 
.55 
	WriteLine55 
(55 
$str55 '
+55( )
query55* /
)55/ 0
;550 1
var66 
userDb66 
=66 
_context66 !
.66! "
Users66" '
.66' (

FromSqlRaw66( 2
(662 3
query663 8
,668 9
userDto66: A
.66A B
Username66B J
,66J K
userDto66L S
.66S T
Password66T \
)66\ ]
.66] ^
FirstOrDefault66^ l
(66l m
)66m n
;66n o
if88 
(88 
userDb88 
==88 
null88 
)88 
{99 
return:: 
Unauthorized:: #
(::# $
$str::$ B
)::B C
;::C D
};; 
return<< 
Ok<< 
(<< 
userDb<< 
)<< 
;<< 
}== 	
[?? 	
HttpPost??	 
(?? 
$str?? 
)?? 
]?? 
public@@ 
IActionResult@@ 
Login@@ "
(@@" #
UserLoginDto@@# /
userDto@@0 7
)@@7 8
{AA 	
ifBB 
(BB 

ModelStateBB 
.BB 
IsValidBB "
==BB# %
falseBB& +
)BB+ ,
{CC 
returnDD 

BadRequestDD !
(DD! "

ModelStateDD" ,
)DD, -
;DD- .
}EE 
varFF 
userFF 
=FF 
newFF 
UserFF 
{GG 
UsernameHH 
=HH 
userDtoHH "
.HH" #
UsernameHH# +
,HH+ ,
PasswordII 
=II 
userDtoII "
.II" #
PasswordII# +
}JJ 
;JJ 
stringLL 
passwordHash1LL  
=LL! "
BCryptLL# )
.LL) *
NetLL* -
.LL- .
BCryptLL. 4
.LL4 5
HashPasswordLL5 A
(LLA B
userLLB F
.LLF G
PasswordLLG O
)LLO P
;LLP Q
ConsoleMM 
.MM 
	WriteLineMM 
(MM 
$strMM 1
+MM2 3
passwordHash1MM4 A
)MMA B
;MMB C
varOO 
	EncDecKeyOO 
=OO 
_configurationOO *
.OO* +
GetValueOO+ 3
<OO3 4
stringOO4 :
>OO: ;
(OO; <
$strOO< G
)OOG H
??OOI K
$strOOL N
;OON O
PasswordManagerPP 
passwordManagerPP +
=PP, -
newPP. 1
(PP1 2
	EncDecKeyPP2 ;
)PP; <
;PP< =
stringQQ 
newPassQQ 
=QQ 
passwordManagerQQ ,
.QQ, -
EncryptQQ- 4
(QQ4 5
userQQ5 9
.QQ9 :
PasswordQQ: B
)QQB C
;QQC D
ConsoleRR 
.RR 
	WriteLineRR 
(RR 
$strRR 4
+RR5 6
newPassRR7 >
)RR> ?
;RR? @
stringTT 
decryptedPassTT  
=TT! "
passwordManagerTT# 2
.TT2 3
DecryptTT3 :
(TT: ;
newPassTT; B
)TTB C
;TTC D
ConsoleUU 
.UU 
	WriteLineUU 
(UU 
$strUU 4
+UU5 6
decryptedPassUU7 D
)UUD E
;UUE F
varWW 
existingUserWW 
=WW 
_contextWW '
.WW' (
UsersWW( -
.WW- .
FirstOrDefaultWW. <
(WW< =
uWW= >
=>WW? A
uWWB C
.WWC D
UsernameWWD L
==WWM O
userWWP T
.WWT U
UsernameWWU ]
)WW] ^
;WW^ _
ifXX 
(XX 
existingUserXX 
!=XX 
nullXX  $
)XX$ %
{YY 
if[[ 
([[ 
BCrypt[[ 
.[[ 
Net[[ 
.[[ 
BCrypt[[ %
.[[% &
Verify[[& ,
([[, -
user[[- 1
.[[1 2
Password[[2 :
,[[: ;
existingUser[[< H
.[[H I
Password[[I Q
)[[Q R
)[[R S
{\\ 
Console]] 
.]] 
	WriteLine]] %
(]]% &
$str]]& ;
)]]; <
;]]< =
}^^ 
else__ 
{`` 
returnaa 
Unauthorizedaa '
(aa' (
$straa( :
)aa: ;
;aa; <
}bb 
}cc 
elsedd 
{ee 
returnff 
NotFoundff 
(ff  
$strff  0
)ff0 1
;ff1 2
}gg 
varjj 
tokenHandlerjj 
=jj 
newjj "#
JwtSecurityTokenHandlerjj# :
(jj: ;
)jj; <
;jj< =
varkk 
JwtKeykk 
=kk 
_configurationkk '
.kk' (
GetValuekk( 0
<kk0 1
stringkk1 7
>kk7 8
(kk8 9
$strkk9 B
)kkB C
??kkD F
$strkkG I
;kkI J
varll 
keyll 
=ll 
Encodingll 
.ll 
ASCIIll $
.ll$ %
GetBytesll% -
(ll- .
JwtKeyll. 4
)ll4 5
;ll5 6
varnn 
tokenDescriptornn 
=nn  !
newnn" %#
SecurityTokenDescriptornn& =
{oo 
Subjectpp 
=pp 
newpp 
ClaimsIdentitypp ,
(pp, -
newpp- 0
Claimpp1 6
[pp6 7
]pp7 8
{qq 
newrr 
Claimrr 
(rr 

ClaimTypesrr (
.rr( )
NameIdentifierrr) 7
,rr7 8
existingUserrr9 E
.rrE F
IdrrF H
.rrH I
ToStringrrI Q
(rrQ R
)rrR S
)rrS T
,rrT U
newss 
Claimss 
(ss 

ClaimTypesss (
.ss( )
Namess) -
,ss- .
existingUserss/ ;
.ss; <
Usernamess< D
)ssD E
}tt 
)tt 
,tt 
Expiresuu 
=uu 
DateTimeuu "
.uu" #
UtcNowuu# )
.uu) *
AddHoursuu* 2
(uu2 3
$numuu3 4
)uu4 5
,uu5 6
SigningCredentialsvv "
=vv# $
newvv% (
SigningCredentialsvv) ;
(vv; <
newvv< ? 
SymmetricSecurityKeyvv@ T
(vvT U
keyvvU X
)vvX Y
,vvY Z
SecurityAlgorithmsvv[ m
.vvm n 
HmacSha256Signature	vvn 
)
vv ‚
}ww 
;ww 
ifxx 
(xx 
tokenDescriptorxx 
!=xx  "
nullxx# '
)xx' (
{yy 
	ParseRolezz 
(zz 
existingUserzz &
.zz& '
Rolezz' +
,zz+ ,
tokenDescriptorzz- <
)zz< =
;zz= >
}{{ 
var}} 
token}} 
=}} 
tokenHandler}} $
.}}$ %
CreateToken}}% 0
(}}0 1
tokenDescriptor}}1 @
)}}@ A
;}}A B
var~~ 
tokenString~~ 
=~~ 
tokenHandler~~ *
.~~* +

WriteToken~~+ 5
(~~5 6
token~~6 ;
)~~; <
;~~< =
existingUser 
. 
Password !
=" #
null$ (
;( )
return
€€ 
Ok
€€ 
(
€€ 
new
€€ 
{
€€ 
Token
€€ !
=
€€" #
tokenString
€€$ /
,
€€/ 0
User
€€1 5
=
€€6 7
existingUser
€€8 D
}
€€E F
)
€€F G
;
€€G H
}
 	
private
ƒƒ 
void
ƒƒ 
	ParseRole
ƒƒ 
(
ƒƒ 
string
ƒƒ %
roles
ƒƒ& +
,
ƒƒ+ ,%
SecurityTokenDescriptor
ƒƒ- D
tokenDescriptor
ƒƒE T
)
ƒƒT U
{
„„ 	
var
…… 
roleList
…… 
=
…… 
roles
……  
.
……  !
Split
……! &
(
……& '
$char
……' *
)
……* +
.
……+ ,
Select
……, 2
(
……2 3
r
……3 4
=>
……5 7
r
……8 9
.
……9 :
Trim
……: >
(
……> ?
)
……? @
)
……@ A
.
……A B
ToList
……B H
(
……H I
)
……I J
;
……J K
foreach
†† 
(
†† 
var
†† 
role
†† 
in
††  
roleList
††! )
)
††) *
{
‡‡ 
tokenDescriptor
ˆˆ 
.
ˆˆ  
Subject
ˆˆ  '
.
ˆˆ' (
AddClaim
ˆˆ( 0
(
ˆˆ0 1
new
ˆˆ1 4
Claim
ˆˆ5 :
(
ˆˆ: ;

ClaimTypes
ˆˆ; E
.
ˆˆE F
Role
ˆˆF J
,
ˆˆJ K
role
ˆˆL P
)
ˆˆP Q
)
ˆˆQ R
;
ˆˆR S
}
‰‰ 
}
ŠŠ 	
}
ŒŒ 
} 